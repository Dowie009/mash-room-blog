<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASHROOM | ULTIMATE_V7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollToPlugin.min.js"></script>
    <script src="https://unpkg.com/@studio-freight/lenis@1.0.42/dist/lenis.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Old+Mincho:wght@700;900&family=Space+Grotesk:wght@300;500;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #050505;
            --text-color: #e0e0e0;
            --accent-color: #ff4d00;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Noto Sans JP', sans-serif;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        .font-mincho { font-family: 'Zen Old Mincho', serif; }
        .font-tech { font-family: 'Space Grotesk', sans-serif; }

        /* --- UI: FLOOR GUIDE --- */
        .floor-link {
            cursor: pointer;
            transition: color 0.3s, opacity 0.3s;
            opacity: 0.5;
            display: block;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .floor-link:hover { opacity: 1; }
        .floor-link.active {
            opacity: 1;
            color: var(--accent-color);
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 77, 0, 0.5);
            font-size: 16px;
        }

        /* --- UI: ENERGY BAR (New!) --- */
        .energy-bar-container {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 90;
            display: none; /* Shown via JS in specific section */
        }
        .energy-bar-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            background: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color);
            transition: height 0.1s linear;
        }
        .energy-label {
            position: absolute;
            bottom: 20px;
            right: 15px;
            transform-origin: right bottom;
            transform: rotate(-90deg);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 12px;
            color: var(--accent-color);
            letter-spacing: 0.2em;
            white-space: nowrap;
        }

        /* --- 1. INTRO & GATE --- */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            z-index: 9999; background: #000; display: flex;
            justify-content: center; align-items: center; overflow: hidden;
        }
        #intro-video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0.6;
        }
        #intro-logo {
            position: relative; z-index: 10; width: 60%; max-width: 600px; opacity: 0;
        }

        .hero-gate-container {
            position: relative; height: 100vh; width: 100%; overflow: hidden; z-index: 50;
        }
        .gate-panel {
            position: absolute; top: 0; width: 50%; height: 100%; background: #000; z-index: 10;
            display: flex; align-items: center; overflow: hidden;
        }
        .gate-left { left: 0; justify-content: flex-end; border-right: 1px solid #222; }
        .gate-right { right: 0; justify-content: flex-start; border-left: 1px solid #222; }
        .gate-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 20; text-align: center; width: 100%; pointer-events: none;
        }

        /* --- 2. PHYSICS LAYERS --- */
        #physics-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 1;
        }
        #physics-container { width: 100%; height: 100%; }

        /* --- 3. HORIZONTAL SCROLL --- */
        .horizontal-wrapper {
            position: relative; z-index: 60; 
            background: transparent; 
            overflow: hidden;
        }
        .horizontal-container { display: flex; flex-wrap: nowrap; height: 100vh; will-change: transform; }
        
        .h-panel {
            width: 100vw; height: 100vh; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            position: relative; box-sizing: border-box; 
            background: rgba(5, 5, 5, 0.85); 
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255,255,255,0.05);
            perspective: 1000px;
        }

        .merge-img-wrapper { transform: translateX(-50px); opacity: 0.5; }
        .merge-text-wrapper { transform: translateX(50px); opacity: 0; }
        
        .tategaki-box {
            writing-mode: vertical-rl; text-orientation: upright; 
            height: 100%; 
            letter-spacing: 0.15em; 
            line-height: 2.2;
        }
        .tategaki-char { display: inline-block; opacity: 0; transform: translateY(20px) scale(1.5); }

        /* --- 4. NEW POST CARDS (DEALER) --- */
        #new-post-section {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
            background: #080808;
            position: relative;
        }

        /* Card Initial State for Dealer Effect */
        .card-dealer {
            opacity: 0;
            transform: translateY(100vh) rotate(15deg); /* Start from bottom */
            will-change: transform, opacity;
        }

        .holo-content {
            position: relative;
            z-index: 2;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            transition: border-color 0.3s;
        }
        .holo-content:hover { border-color: var(--accent-color); }

        /* --- 5. FOOTER --- */
        #footer-physics-wrapper {
            position: relative; width: 100%; height: 100vh; background: #000; z-index: 70;
            overflow: hidden; display: flex; justify-content: center; align-items: center;
        }
        #footer-physics-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .footer-overlay { position: relative; z-index: 10; pointer-events: none; text-align: center; mix-blend-mode: difference; }

        /* --- UTILS --- */
        .noise-overlay {
            position: absolute; inset: 0; 
            background: url('https://grainy-gradients.vercel.app/noise.svg'); 
            opacity: 0.15; mix-blend-overlay; pointer-events: none;
        }
        .glitch-text span { display: inline-block; transition: transform 0.3s, color 0.3s; }
        .glitch-text:hover span { color: var(--accent-color); transform: translateY(-10px) rotate(5deg); }
    </style>
</head>
<body>

    <!-- 0. INTRO -->
    <div id="intro-overlay">
        <video id="intro-video" autoplay muted playsinline>
            <source src="/images/into3.mp4" type="video/mp4">
        </video>
        <img id="intro-logo" src="/images/MASHROOM_Logo.png" alt="MASHROOM LOGO">
    </div>

    <!-- 1. BG PHYSICS -->
    <div id="physics-wrapper">
        <video autoplay loop muted playsinline class="absolute inset-0 w-full h-full object-cover opacity-60 grayscale contrast-125">
            <source src="/images/sunset-bg.mp4" type="video/mp4">
        </video>
        <div class="noise-overlay"></div>
        <div id="physics-container"></div>
    </div>

    <!-- ENERGY BAR (For New Post Section) -->
    <div class="energy-bar-container" id="energy-bar">
        <div class="energy-bar-fill" id="energy-fill"></div>
        <div class="energy-label">ENERGY CHARGE</div>
    </div>


    <!-- MAIN SCROLL WRAPPER -->
    <div id="main-scroll-wrapper" class="relative z-50">

        <!-- HEADER & GUIDE -->
        <header class="fixed top-0 w-full p-8 flex justify-between items-start z-[100] mix-blend-difference text-white pointer-events-none">
            <div class="pointer-events-auto">
                <h1 class="font-tech text-xl font-bold tracking-tighter leading-none">
                    MASH<br><span class="text-[var(--accent-color)]">ROOM</span>
                </h1>
            </div>
            <div class="pointer-events-auto text-right font-mono tracking-widest">
                <div class="border border-white/50 rounded-full px-5 py-2 mb-3 bg-black/20 backdrop-blur text-sm">
                    FLOOR GUIDE
                </div>
                <nav class="flex flex-col gap-2 opacity-90">
                    <a data-target="#hero-section" class="floor-link">GATE: HERO</a>
                    <a data-target="#horizontal-wrapper" class="floor-link">1F: READING</a>
                    <a data-target="#new-post-section" class="floor-link">2F: NEW POST</a>
                    <a data-target="#footer-physics-wrapper" class="floor-link">3F: DEPART</a>
                </nav>
            </div>
        </header>


        <!-- 2. HERO GATE -->
        <section class="hero-gate-container" id="hero-section">
            <div class="gate-panel gate-left">
                <div class="absolute inset-0 w-[200vw] h-full bg-black">
                     <video autoplay loop muted playsinline class="w-full h-full object-cover opacity-40">
                        <source src="/images/sunset-bg.mp4" type="video/mp4">
                    </video>
                </div>
            </div>
            <div class="gate-panel gate-right">
                <div class="absolute inset-0 w-[200vw] h-full bg-black -left-[100%]">
                    <video autoplay loop muted playsinline class="w-full h-full object-cover opacity-40">
                        <source src="/images/sunset-bg.mp4" type="video/mp4">
                    </video>
                </div>
            </div>
            <div class="gate-content">
                <p class="font-mono text-sm tracking-[1em] mb-8 text-white/70">SAPPORO STUDIO</p>
                <h2 class="font-mincho text-[10vw] leading-[0.9] font-black text-white mix-blend-overlay">
                    物語と<br>技術の<br>交差点
                </h2>
                <div class="mt-12 animate-bounce">
                    <span class="font-mono text-xs tracking-widest text-gray-400">SCROLL TO OPEN GATE</span>
                </div>
            </div>
        </section>


        <!-- 3. HORIZONTAL READING -->
        <section class="horizontal-wrapper" id="horizontal-wrapper">
            <div class="horizontal-container">
                
                <!-- Spacer Panel -->
                <div class="h-panel bg-black/50 pointer-events-none">
                    <div class="bg-black/80 backdrop-blur-md p-16 max-w-2xl text-center border border-white/10 pointer-events-auto shadow-2xl">
                        <span class="text-[var(--accent-color)] font-mono text-lg mb-6 block">FLOOR 1</span>
                        <h3 class="font-mincho text-7xl md:text-8xl mb-8 leading-none">重力と<br>遊ぶ</h3>
                        <p class="text-xl text-gray-400 leading-loose mb-12 font-bold">
                            扉が開くと、<br>
                            ガラスの向こうでアイデアが降り注ぐ。<br>
                            (今、裏でブロックが落ちてます！)
                        </p>
                        <div class="font-mono text-sm text-gray-500 animate-pulse">
                            SCROLL DOWN TO DIVE &rarr;
                        </div>
                    </div>
                </div>

                <!-- Story Panel -->
                <div class="h-panel" id="panel-story">
                    <div class="container mx-auto px-8 md:px-12 grid grid-cols-1 md:grid-cols-2 gap-12 md:gap-20 items-center h-full max-w-6xl">
                        <div class="merge-img-wrapper relative group cursor-pointer w-auto h-[60vh] md:h-[70vh] aspect-[3/4] mx-auto holo-content shadow-2xl">
                            <img src="https://images.unsplash.com/photo-1598488035139-bdbb2231ce04?q=80&w=2070&auto=format&fit=crop" 
                                class="w-full h-full object-cover grayscale group-hover:grayscale-0 rounded-sm transition-all duration-700" alt="Story">
                            <a href="#" class="absolute -bottom-6 -right-6 bg-white text-black font-mono text-xs font-bold px-6 py-3 hover:bg-[var(--accent-color)] hover:text-white transition-colors pointer-events-auto shadow-lg">
                                READ STORIES
                            </a>
                        </div>
                        <div class="merge-text-wrapper h-[60vh] md:h-[70vh] flex items-center justify-center md:justify-start pl-8 md:pl-16 border-l border-white/10">
                            <div class="tategaki-box flex flex-col justify-center">
                                <span class="text-[var(--accent-color)] font-mono text-xs font-bold tracking-widest mb-8 block tategaki-char" style="writing-mode: horizontal-tb;">CHAPTER 01</span>
                                <h3 class="font-mincho text-3xl md:text-4xl font-black mb-12 leading-relaxed">
                                    <span class="tategaki-char">物</span><span class="tategaki-char">語</span><span class="tategaki-char">の</span><br>
                                    <span class="tategaki-char">積</span><span class="tategaki-char">み</span><span class="tategaki-char">重</span><span class="tategaki-char">ね</span>
                                </h3>
                                <p class="text-gray-400 font-medium text-sm md:text-base leading-loose">
                                    <span class="tategaki-char">ブ</span><span class="tategaki-char">ロ</span><span class="tategaki-char">グ</span><span class="tategaki-char">は</span><span class="tategaki-char">地</span><span class="tategaki-char">層</span><span class="tategaki-char">の</span><span class="tategaki-char">よ</span><span class="tategaki-char">う</span><span class="tategaki-char">に</span><span class="tategaki-char">。</span><br>
                                    <span class="tategaki-char">玄</span><span class="tategaki-char">関</span><span class="tategaki-char">の</span><span class="tategaki-char">壁</span><span class="tategaki-char">を</span><span class="tategaki-char">撤</span><span class="tategaki-char">去</span><span class="tategaki-char">し</span><span class="tategaki-char">、</span><br>
                                    <span class="tategaki-char">新</span><span class="tategaki-char">し</span><span class="tategaki-char">い</span><span class="tategaki-char">風</span><span class="tategaki-char">を</span><span class="tategaki-char">通</span><span class="tategaki-char">す</span><span class="tategaki-char">。</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gear Panel -->
                <div class="h-panel" id="panel-gear">
                    <div class="container mx-auto px-8 md:px-12 grid grid-cols-1 md:grid-cols-2 gap-12 md:gap-20 items-center h-full max-w-6xl">
                        <div class="merge-img-wrapper relative group cursor-pointer w-auto h-[60vh] md:h-[70vh] aspect-[3/4] mx-auto holo-content shadow-2xl">
                            <img src="https://images.unsplash.com/photo-1593693397690-362e5ebf8840?q=80&w=2070&auto=format&fit=crop" 
                                class="w-full h-full object-cover grayscale group-hover:grayscale-0 rounded-sm transition-all duration-700" alt="Gear">
                            <a href="#" class="absolute -bottom-6 -right-6 bg-white text-black font-mono text-xs font-bold px-6 py-3 hover:bg-[var(--accent-color)] hover:text-white transition-colors pointer-events-auto shadow-lg">
                                CHECK GEARS
                            </a>
                        </div>
                        <div class="merge-text-wrapper h-[60vh] md:h-[70vh] flex items-center justify-center md:justify-start pl-8 md:pl-16 border-l border-white/10">
                            <div class="tategaki-box flex flex-col justify-center">
                                <span class="text-[var(--accent-color)] font-mono text-xs font-bold tracking-widest mb-8 block tategaki-char" style="writing-mode: horizontal-tb;">CHAPTER 02</span>
                                <h3 class="font-mincho text-3xl md:text-4xl font-black mb-12 leading-relaxed">
                                    <span class="tategaki-char">没</span><span class="tategaki-char">入</span><span class="tategaki-char">す</span><span class="tategaki-char">る</span><br>
                                    <span class="tategaki-char">機</span><span class="tategaki-char">材</span><span class="tategaki-char">た</span><span class="tategaki-char">ち</span>
                                </h3>
                                <p class="text-gray-400 font-medium text-sm md:text-base leading-loose">
                                    <span class="tategaki-char">3</span><span class="tategaki-char">7</span><span class="tategaki-char">.</span><span class="tategaki-char">5</span><span class="tategaki-char">イ</span><span class="tategaki-char">ン</span><span class="tategaki-char">チ</span><span class="tategaki-char">の</span><span class="tategaki-char">湾</span><span class="tategaki-char">曲</span><span class="tategaki-char">。</span><br>
                                    <span class="tategaki-char">視</span><span class="tategaki-char">界</span><span class="tategaki-char">を</span><span class="tategaki-char">覆</span><span class="tategaki-char">う</span><span class="tategaki-char">情</span><span class="tategaki-char">報</span><span class="tategaki-char">の</span><span class="tategaki-char">海</span><span class="tategaki-char">。</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tech Panel -->
                <div class="h-panel" id="panel-tech">
                    <div class="container mx-auto px-8 md:px-12 grid grid-cols-1 md:grid-cols-2 gap-12 md:gap-20 items-center h-full max-w-6xl">
                         <div class="merge-img-wrapper relative group cursor-pointer w-auto h-[60vh] md:h-[70vh] aspect-[3/4] mx-auto holo-content shadow-2xl">
                            <img src="https://images.unsplash.com/photo-1518770660439-4636190af475?q=80&w=2070&auto=format&fit=crop" 
                                class="w-full h-full object-cover grayscale group-hover:grayscale-0 rounded-sm transition-all duration-700" alt="Tech">
                            <a href="#" class="absolute -bottom-6 -right-6 bg-white text-black font-mono text-xs font-bold px-6 py-3 hover:bg-[var(--accent-color)] hover:text-white transition-colors pointer-events-auto shadow-lg">
                                EXPLORE LAB
                            </a>
                        </div>
                        <div class="merge-text-wrapper h-[60vh] md:h-[70vh] flex items-center justify-center md:justify-start pl-8 md:pl-16 border-l border-white/10">
                            <div class="tategaki-box flex flex-col justify-center">
                                <span class="text-[var(--accent-color)] font-mono text-xs font-bold tracking-widest mb-8 block tategaki-char" style="writing-mode: horizontal-tb;">CHAPTER 03</span>
                                <h3 class="font-mincho text-3xl md:text-4xl font-black mb-12 leading-relaxed">
                                    <span class="tategaki-char">技</span><span class="tategaki-char">術</span><span class="tategaki-char">と</span><br>
                                    <span class="tategaki-char">そ</span><span class="tategaki-char">の</span><span class="tategaki-char">先</span><span class="tategaki-char">へ</span>
                                </h3>
                                <p class="text-gray-400 font-medium text-sm md:text-base leading-loose">
                                    <span class="tategaki-char">人</span><span class="tategaki-char">工</span><span class="tategaki-char">知</span><span class="tategaki-char">能</span><span class="tategaki-char">と</span><span class="tategaki-char">共</span><span class="tategaki-char">創</span><span class="tategaki-char">す</span><span class="tategaki-char">る</span><span class="tategaki-char">。</span><br>
                                    <span class="tategaki-char">コ</span><span class="tategaki-char">ー</span><span class="tategaki-char">ド</span><span class="tategaki-char">は</span><span class="tategaki-char">詩</span><span class="tategaki-char">に</span><span class="tategaki-char">な</span><span class="tategaki-char">る</span><span class="tategaki-char">。</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>


        <!-- 4. NEW POSTS (Card Dealer & Energy Charge) -->
        <section class="py-24 px-6 bg-[#080808] relative z-60 min-h-screen flex flex-col justify-center" id="new-post-section">
            <div class="container mx-auto h-full flex flex-col justify-center">
                <div class="flex items-end justify-between mb-10 border-b border-white/10 pb-6">
                    <div class="glitch-text cursor-default">
                        <h2 class="font-tech text-6xl md:text-8xl font-bold text-white/90">
                            <span class="inline-block">N</span><span class="inline-block">E</span><span class="inline-block">W</span><span class="inline-block">_</span><span class="inline-block">P</span><span class="inline-block">O</span><span class="inline-block">S</span><span class="inline-block">T</span>
                        </h2>
                    </div>
                    <div class="text-right">
                        <h3 class="font-mincho text-2xl font-bold text-white mb-1">新着記事</h3>
                        <span class="font-mono text-xs text-[var(--accent-color)]">LATEST UPDATES</span>
                    </div>
                </div>

                <!-- 6 Grid Layout -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="card-grid">
                    
                    <!-- Row 1: Smaller Cards (height constrained) -->
                    <!-- Post 1 -->
                    <div class="h-[35vh] card-dealer group cursor-pointer relative holo-content">
                        <img src="https://images.unsplash.com/photo-1598488035139-bdbb2231ce04?q=80&w=2070&auto=format&fit=crop" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500">
                        <div class="absolute top-4 left-4 bg-black text-white font-mono text-[10px] px-2 py-1 z-10">DIY</div>
                        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent z-10">
                            <span class="font-mono text-[10px] text-gray-400 block mb-1">2025.12.01</span>
                            <h3 class="font-mincho text-base font-bold text-white group-hover:text-[var(--accent-color)]">玄関の壁を撤去してZONE Aと繋げた話</h3>
                        </div>
                    </div>
                    <!-- Post 2 -->
                    <div class="h-[35vh] card-dealer group cursor-pointer relative holo-content">
                        <img src="https://images.unsplash.com/photo-1593693397690-362e5ebf8840?q=80&w=2070&auto=format&fit=crop" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500">
                        <div class="absolute top-4 left-4 bg-black text-white font-mono text-[10px] px-2 py-1 z-10">GEAR</div>
                         <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent z-10">
                            <span class="font-mono text-[10px] text-gray-400 block mb-1">2025.11.28</span>
                            <h3 class="font-mincho text-base font-bold text-white group-hover:text-[var(--accent-color)]">37.5型湾曲モニター導入で見えた世界</h3>
                        </div>
                    </div>
                    <!-- Post 3 -->
                    <div class="h-[35vh] card-dealer group cursor-pointer relative holo-content">
                        <img src="https://images.unsplash.com/photo-1511379938547-c1f69419868d?q=80&w=2070&auto=format&fit=crop" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500">
                        <div class="absolute top-4 left-4 bg-black text-white font-mono text-[10px] px-2 py-1 z-10">BIZ</div>
                         <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent z-10">
                            <span class="font-mono text-[10px] text-gray-400 block mb-1">2025.11.15</span>
                            <h3 class="font-mincho text-base font-bold text-white group-hover:text-[var(--accent-color)]">補助金と新人発掘とスタジオ経営</h3>
                        </div>
                    </div>

                    <!-- Row 2: Even Smaller Cards -->
                    <!-- Post 4 -->
                    <div class="h-[25vh] card-dealer group cursor-pointer relative holo-content">
                        <img src="https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=2070&auto=format&fit=crop" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500">
                        <div class="absolute top-4 left-4 bg-black text-white font-mono text-[10px] px-2 py-1 z-10">TECH</div>
                         <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent z-10">
                            <span class="font-mono text-[10px] text-gray-400 block mb-1">2025.10.30</span>
                            <h3 class="font-mincho text-sm font-bold text-white group-hover:text-[var(--accent-color)]">音の粒を可視化する技術</h3>
                        </div>
                    </div>
                    <!-- Post 5 -->
                    <div class="h-[25vh] card-dealer group cursor-pointer relative holo-content">
                        <img src="https://images.unsplash.com/photo-1514320291840-2e0a9bf2a9ae?q=80&w=2070&auto=format&fit=crop" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500">
                        <div class="absolute top-4 left-4 bg-black text-white font-mono text-[10px] px-2 py-1 z-10">LOCAL</div>
                         <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent z-10">
                            <span class="font-mono text-[10px] text-gray-400 block mb-1">2025.10.15</span>
                            <h3 class="font-mincho text-sm font-bold text-white group-hover:text-[var(--accent-color)]">札幌の夜と音楽と</h3>
                        </div>
                    </div>
                    <!-- Post 6 -->
                    <div class="h-[25vh] card-dealer group cursor-pointer relative holo-content">
                        <img src="https://images.unsplash.com/photo-1501386761106-e84b72d23203?q=80&w=2070&auto=format&fit=crop" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500">
                        <div class="absolute top-4 left-4 bg-black text-white font-mono text-[10px] px-2 py-1 z-10">STORY</div>
                         <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent z-10">
                            <span class="font-mono text-[10px] text-gray-400 block mb-1">2025.10.01</span>
                            <h3 class="font-mincho text-sm font-bold text-white group-hover:text-[var(--accent-color)]">スタジオ設立の裏話</h3>
                        </div>
                    </div>

                </div>
            </div>
        </section>


        <!-- 5. FOOTER PHYSICS (Button Rain Re-Trigger) -->
        <section id="footer-physics-wrapper">
            <div id="footer-physics-canvas"></div>
            
            <div class="footer-overlay relative z-50">
                <p class="font-mono text-xs tracking-[0.5em] text-white/50 mb-8 animate-pulse">CHOOSE YOUR PATH</p>
                <div class="font-tech text-4xl font-bold text-white mb-4">
                    CLICK FALLING BLOCKS
                </div>
                <div class="font-mono text-[10px] text-gray-400">
                    &copy; 2025 SAPPORO MASHROOM STUDIO
                </div>
            </div>
        </section>

    </div> <!-- End Main Wrapper -->


    <script>
        lucide.createIcons();
        gsap.registerPlugin(ScrollTrigger, ScrollToPlugin);

        /* ------------------------------------------------
           0. SMOOTH SCROLL (LENIS)
           ------------------------------------------------ */
        const lenis = new Lenis({
            duration: 1.2,
            easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
            smooth: true,
        });
        function raf(time) {
            lenis.raf(time);
            requestAnimationFrame(raf);
        }
        requestAnimationFrame(raf);


        /* ------------------------------------------------
           1. FLOOR GUIDE (Fixed Logic)
           ------------------------------------------------ */
        // Use ScrollTrigger to update active class accurately even with pinning
        const navLinks = document.querySelectorAll('.floor-link');
        
        navLinks.forEach(link => {
            const targetId = link.getAttribute('data-target');
            if(targetId) {
                ScrollTrigger.create({
                    trigger: targetId,
                    start: "top center",
                    end: "bottom center",
                    onToggle: self => {
                        if(self.isActive) {
                            navLinks.forEach(l => l.classList.remove('active'));
                            link.classList.add('active');
                        }
                    }
                });
            }
            
            // Click scroll
            link.addEventListener('click', (e) => {
                const target = document.querySelector(targetId);
                lenis.scrollTo(target);
            });
        });


        /* ------------------------------------------------
           2. INTRO & GATE ANIMATION
           ------------------------------------------------ */
        const startIntro = () => {
            const tl = gsap.timeline({
                onComplete: () => {
                    initPhysics();
                }
            });
            tl.to("#intro-logo", { opacity: 1, scale: 1, duration: 1, ease: "power2.out", delay: 0.5 })
              .to("#intro-logo", { scale: 1.05, duration: 1.5 })
              .to("#intro-logo", { opacity: 0, scale: 1.2, duration: 0.5 }, "-=0.2")
              .to("#intro-overlay", { opacity: 0, duration: 1, pointerEvents: 'none' });
        };
        window.addEventListener('load', startIntro);

        const gateTl = gsap.timeline({
            scrollTrigger: {
                trigger: ".hero-gate-container",
                start: "top top",
                end: "+=100%",
                scrub: 1,
                pin: true,
            }
        });
        gateTl.to(".gate-left", { xPercent: -100, ease: "none" }, "open")
              .to(".gate-right", { xPercent: 100, ease: "none" }, "open")
              .to(".gate-content", { y: -200, opacity: 0, ease: "none" }, "open");


        /* ------------------------------------------------
           3. BACKGROUND PHYSICS (Floor 1)
           ------------------------------------------------ */
        const initPhysics = () => {
            const container = document.getElementById('physics-container');
            if(container.childNodes.length > 0) return;

            const Engine = Matter.Engine,
                  Render = Matter.Render,
                  World = Matter.World,
                  Bodies = Matter.Bodies,
                  Runner = Matter.Runner;

            const engine = Engine.create();
            const render = Render.create({
                element: container,
                engine: engine,
                options: {
                    width: window.innerWidth,
                    height: window.innerHeight,
                    background: 'transparent',
                    wireframes: false
                }
            });

            const ground = Bodies.rectangle(window.innerWidth/2, window.innerHeight + 100, window.innerWidth, 200, { isStatic: true, render: { visible: false } });
            const leftWall = Bodies.rectangle(-50, window.innerHeight/2, 100, window.innerHeight*2, { isStatic: true, render: { visible: false } });
            const rightWall = Bodies.rectangle(window.innerWidth + 50, window.innerHeight/2, 100, window.innerHeight*2, { isStatic: true, render: { visible: false } });

            const blocks = Array.from({ length: 60 }).map((_, i) => {
                const x = Math.random() * (window.innerWidth - 200) + 100;
                const y = -Math.random() * 2000 - 200; 
                return Bodies.rectangle(x, y, 160 + Math.random()*40, 100 + Math.random()*20, {
                    chamfer: { radius: 8 },
                    restitution: 0.6,
                    render: {
                        fillStyle: 'rgba(0,0,0,0.5)',
                        strokeStyle: i % 2 === 0 ? '#ff4d00' : '#ffffff',
                        lineWidth: 3
                    }
                });
            });

            World.add(engine.world, [ground, leftWall, rightWall, ...blocks]);
            Runner.run(Runner.create(), engine);
            Render.run(render);
        };


        /* ------------------------------------------------
           4. HORIZONTAL SCROLL (SHORTENED DISTANCE)
           ------------------------------------------------ */
        const wrapper = document.querySelector('.horizontal-wrapper');
        const container = document.querySelector('.horizontal-container');
        const panels = gsap.utils.toArray('.h-panel');
        
        const tl = gsap.timeline({
            scrollTrigger: {
                trigger: wrapper,
                pin: true,
                scrub: 1,
                // REDUCED DISTANCE (was 2.0 -> 1.3) for faster transition
                end: () => "+=" + (panels.length * window.innerWidth * 1.3), 
            }
        });

        panels.forEach((panel, i) => {
            if (i === 0) return; 

            // 1. Transition
            tl.to(container, {
                x: - (i * 100) + "vw", 
                ease: "none",
                duration: 1
            });

            // 2. Lock
            tl.to({}, { duration: 0.5 }); 

            // 3. Animation
            const img = panel.querySelector('.merge-img-wrapper');
            const txt = panel.querySelector('.merge-text-wrapper');
            const chars = panel.querySelectorAll('.tategaki-char');

            if(img && txt) {
                tl.fromTo(img, { x: -50, opacity: 0 }, { x: 0, opacity: 1, duration: 0.5, ease: "power2.out" }, "<");
                tl.fromTo(txt, { x: 50, opacity: 0 }, { x: 0, opacity: 1, duration: 0.5, ease: "power2.out" }, "<");
                tl.fromTo(chars, 
                    { y: 20, opacity: 0, scale: 1.5 },
                    { y: 0, opacity: 1, scale: 1, stagger: 0.05, duration: 0.5, ease: "back.out(1.7)" }, 
                    "<+=0.1"
                );
            }

            // 4. Wait
            tl.to({}, { duration: 0.2 });
        });


        /* ------------------------------------------------
           5. NEW POST: DEALER & ENERGY
           ------------------------------------------------ */
        const newPostSection = document.getElementById('new-post-section');
        const energyBar = document.getElementById('energy-bar');
        const energyFill = document.getElementById('energy-fill');
        
        // Show Energy Bar only in this section
        ScrollTrigger.create({
            trigger: newPostSection,
            start: "top bottom",
            end: "bottom top",
            onEnter: () => energyBar.style.display = 'block',
            onLeave: () => energyBar.style.display = 'none',
            onEnterBack: () => energyBar.style.display = 'block',
            onLeaveBack: () => energyBar.style.display = 'none',
        });

        const dealerTl = gsap.timeline({
            scrollTrigger: {
                trigger: newPostSection,
                pin: true,
                start: "top top",
                end: "+=150%", // Extend scroll distance for dealing cards
                scrub: 1, // Directly linked to scroll position
                onUpdate: self => {
                    // Update Energy Fill
                    energyFill.style.height = (self.progress * 100) + '%';
                }
            }
        });

        // Set initial state for dealer cards
        const cards = document.querySelectorAll('.card-dealer');
        cards.forEach(card => {
            // Start from bottom off-screen with rotation
            gsap.set(card, { y: window.innerHeight, rotation: Math.random() * 30 - 15, opacity: 0 });
        });

        // Deal cards one by one based on scroll
        cards.forEach((card, i) => {
            dealerTl.to(card, {
                y: 0,
                rotation: 0,
                opacity: 1,
                duration: 1,
                ease: "power2.out"
            }, i * 0.2); // Overlap slightly
        });


        /* ------------------------------------------------
           6. FOOTER PHYSICS
           ------------------------------------------------ */
        let footerEngine, footerRender, footerRunner;
        const footerCanvas = document.getElementById('footer-physics-canvas');

        const cleanupFooterPhysics = () => {
            if (footerRender) {
                Matter.Render.stop(footerRender);
                Matter.Runner.stop(footerRunner);
                Matter.Engine.clear(footerEngine);
                if(footerRender.canvas) footerRender.canvas.remove();
                footerRender = null;
                footerEngine = null;
                footerRunner = null;
            }
        };

        const initFooterPhysics = () => {
            if (footerRender) return;

            const Engine = Matter.Engine,
                  Render = Matter.Render,
                  World = Matter.World,
                  Bodies = Matter.Bodies,
                  Mouse = Matter.Mouse,
                  MouseConstraint = Matter.MouseConstraint,
                  Runner = Matter.Runner,
                  Events = Matter.Events;

            footerEngine = Engine.create();
            footerRender = Render.create({
                element: footerCanvas,
                engine: footerEngine,
                options: {
                    width: window.innerWidth,
                    height: window.innerHeight,
                    background: 'transparent',
                    wireframes: false
                }
            });

            const ground = Bodies.rectangle(window.innerWidth/2, window.innerHeight + 50, window.innerWidth, 100, { isStatic: true, render: { visible: false } });
            const leftWall = Bodies.rectangle(-50, window.innerHeight/2, 100, window.innerHeight, { isStatic: true, render: { visible: false } });
            const rightWall = Bodies.rectangle(window.innerWidth + 50, window.innerHeight/2, 100, window.innerHeight, { isStatic: true, render: { visible: false } });

            const labels = ['物語', '機材', '技術'];
            const colors = ['#ffffff', '#ff4d00', '#333333'];
            const links = ['#', '#', '#']; 

            const blocks = [];
            for (let i = 0; i < 60; i++) { 
                const x = Math.random() * (window.innerWidth - 100) + 50;
                const y = -Math.random() * 2500 - 100;
                const typeIdx = Math.floor(Math.random() * 3);
                
                const block = Bodies.rectangle(x, y, 120, 60, {
                    chamfer: { radius: 8 },
                    restitution: 0.5,
                    label: labels[typeIdx],
                    render: {
                        fillStyle: colors[typeIdx],
                        strokeStyle: '#ffffff',
                        lineWidth: 1
                    }
                });
                block.urlLink = links[typeIdx];
                blocks.push(block);
            }

            World.add(footerEngine.world, [ground, leftWall, rightWall, ...blocks]);

            const mouse = Mouse.create(footerRender.canvas);
            const mouseConstraint = MouseConstraint.create(footerEngine, {
                mouse: mouse,
                constraint: { stiffness: 0.2, render: { visible: false } }
            });
            World.add(footerEngine.world, mouseConstraint);
            footerRender.mouse = mouse;

            Events.on(mouseConstraint, 'mousedown', function(event) {
                const body = event.source.body;
                if (body && body.label) {
                    console.log("Navigating to: " + body.label);
                }
            });

            Events.on(footerRender, 'afterRender', function() {
                const ctx = footerRender.context;
                ctx.font = "bold 16px 'Noto Sans JP'"; 
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";

                blocks.forEach(block => {
                    const { x, y } = block.position;
                    const angle = block.angle;
                    ctx.save();
                    ctx.translate(x, y);
                    ctx.rotate(angle);
                    ctx.fillStyle = block.render.fillStyle === '#ffffff' ? '#000' : '#fff';
                    ctx.fillText(block.label, 0, 0);
                    ctx.restore();
                });
            });

            footerRunner = Runner.create();
            Runner.run(footerRunner, footerEngine);
            Render.run(footerRender);
            
             window.addEventListener('resize', () => {
                if(footerRender) {
                    footerRender.canvas.width = window.innerWidth;
                    footerRender.canvas.height = window.innerHeight;
                }
            });
        };

        ScrollTrigger.create({
            trigger: "#footer-physics-wrapper",
            start: "top 60%", 
            onEnter: initFooterPhysics,
            onLeaveBack: cleanupFooterPhysics 
        });

    </script>
</body>
</html>