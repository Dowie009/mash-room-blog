---
interface Props {
  title: string;
  date: Date;
  category: string;
  thumbnail: string;
  description?: string;
  tags?: string[];
  slug: string;
  gridSize?: {
    colSpan?: number;
    rowSpan?: number;
    height?: number;
  };
  index?: number;
}

const { 
  title, 
  date, 
  category, 
  thumbnail, 
  description, 
  tags = [], 
  slug,
  gridSize = { colSpan: 12, rowSpan: 1 }
} = Astro.props;

const formatDate = (date: Date) => {
  return date.toLocaleDateString('ja-JP', { 
    year: 'numeric', 
    month: '2-digit', 
    day: '2-digit' 
  }).replace(/\//g, '.');
};

const categoryLabels: Record<string, string> = {
  'daw': 'DAW',
  'gear': 'GEAR',
  'plugin': 'PLUGIN',
  'biz': 'BIZ',
  'tips': 'TIPS',
  'essay': 'ESSAY',
};

const colSpanClass = `col-span-${gridSize.colSpan ?? 12}`;
const rowSpanClass = gridSize.rowSpan && gridSize.rowSpan > 1 ? `row-span-${gridSize.rowSpan}` : '';
---

<article 
  class={`lab-card group item ${colSpanClass} ${rowSpanClass}`} 
  data-category={category} 
  data-date={date.toISOString().split('T')[0]}
>
  <div class="card-img-wrap" style={gridSize.height ? `height: ${gridSize.height}px;` : ''}>
    <img src={thumbnail} alt={title} class="card-img" loading="lazy" />
  </div>
  <div class="card-content">
    <div class="card-meta">
      <span>{categoryLabels[category] || category.toUpperCase()}</span>
      <span>{formatDate(date)}</span>
    </div>
    <h3 class="card-title">{title}</h3>
    {description && (
      <p class="text-gray-500 text-xs mt-auto line-clamp-2 leading-loose">{description}</p>
    )}
    {tags.length > 0 && tags.some(tag => ['Macro Command', 'Workflow'].includes(tag)) && (
      <span class="code-snippet">{tags.find(tag => ['Macro Command', 'Workflow'].includes(tag))}</span>
    )}
  </div>
</article>

<style>
  .lab-card {
    position: relative;
    display: flex;
    flex-direction: column;
    cursor: pointer;
    opacity: 1;
    background: var(--card-bg, #ffffff);
    border-radius: 6px;
    overflow: hidden;
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), box-shadow 0.3s;
    border: 1px solid transparent;
    transform: translateZ(0); /* GPU加速を有効化 */
    backface-visibility: hidden; /* レンダリング最適化 */
    will-change: transform;
  }
  
  .lab-card:hover {
    transform: translateY(-5px);
    z-index: 10;
    box-shadow: 0 10px 30px -10px rgba(0,122,255,0.15);
    border-color: var(--accent-color, #007aff);
  }
  
  .card-img-wrap {
    width: 100%;
    overflow: hidden;
    position: relative;
    background: #e2e8f0;
  }
  
  .card-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s, filter 0.5s;
    filter: grayscale(100%);
    transform: scale(1.0);
    display: block;
  }
  
  .lab-card:hover .card-img {
    filter: grayscale(0%);
    transform: scale(1.05);
  }
  
  .card-content {
    padding: 1.2rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  
  .card-meta {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 0.6rem;
    color: var(--text-sub, #64748b);
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    border-bottom: 1px solid #f1f5f9;
    padding-bottom: 0.3rem;
  }
  
  .card-title {
    font-family: 'Zen Old Mincho', serif;
    font-size: 1.1rem;
    font-weight: 700;
    line-height: 1.4;
    margin-bottom: 0.2rem;
    color: var(--text-main, #0f172a);
  }
  
  .code-snippet {
    font-family: 'Fira Code', monospace;
    font-size: 0.6rem;
    color: var(--accent-color, #007aff);
    background: rgba(0,122,255,0.05);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    margin-top: auto;
    display: inline-block;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>