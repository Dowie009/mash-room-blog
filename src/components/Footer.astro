---
// Footer Section: Physics Effect with Falling Blocks
---

<!-- 5. FOOTER PHYSICS (Button Rain Re-Trigger) -->
<section id="footer-physics-wrapper">
    <div id="footer-physics-canvas"></div>

    <div class="footer-overlay relative z-50">
        <!-- 3Fグリッチメニュー（ブロック落下後に登場） -->
        <nav id="floor-guide-3f" class="floor-3f-menu mb-10">
            <div class="flex items-center justify-center gap-4 flex-wrap">
                <a data-target="#hero-section" class="glitch-menu-link" data-text="GATE">GATE</a>
                <span class="menu-separator">|</span>
                <a data-target="#horizontal-wrapper" class="glitch-menu-link" data-text="1F">1F</a>
                <span class="menu-separator">|</span>
                <a data-target="#new-post-section" class="glitch-menu-link" data-text="2F">2F</a>
                <span class="menu-separator">|</span>
                <a href="#" class="glitch-menu-link inactive" data-text="STORY">STORY</a>
                <a href="/gear" class="glitch-menu-link" data-text="GEAR">GEAR</a>
                <a href="#" class="glitch-menu-link inactive" data-text="TECH">TECH</a>
            </div>
        </nav>
        <p class="font-mono text-xs tracking-[0.5em] text-white/50 mb-8 animate-pulse">CHOOSE YOUR PATH</p>
        <div class="font-tech text-4xl font-bold text-white mb-4">
            CLICK FALLING BLOCKS
        </div>
        <div class="font-mono text-[10px] text-gray-400">
            &copy; 2025 SAPPORO MASHROOM STUDIO
        </div>
    </div>
</section>

<style>
    /* --- 5. FOOTER --- */
    #footer-physics-wrapper {
        position: relative; 
        width: 100%; 
        height: 100vh; 
        background: #000; 
        z-index: 70;
        overflow: hidden; 
        display: flex; 
        justify-content: center; 
        align-items: center;
    }
    #footer-physics-canvas { 
        position: absolute; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
    }
    .footer-overlay {
        position: relative;
        z-index: 10;
        pointer-events: none;
        text-align: center;
        mix-blend-mode: difference;
        /* 全体を3cm（約40px）上に移動 */
        transform: translateY(-40px);
    }

    /* --- 3Fグリッチメニュー --- */
    .floor-3f-menu {
        opacity: 0;
        transform: translateY(-20px);
        pointer-events: none;
        transition: opacity 0.5s ease, transform 0.5s ease;
    }

    .floor-3f-menu.visible {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
    }

    .glitch-menu-link {
        font-family: 'Space Grotesk', monospace;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.2em;
        color: #fff;
        text-decoration: none;
        cursor: pointer;
        position: relative;
        padding: 8px 16px;
        background: transparent;
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 2px;
        transition: all 0.3s ease;
        pointer-events: auto;
    }

    .glitch-menu-link.inactive {
        color: rgba(255,255,255,0.4);
        border-color: rgba(255,255,255,0.1);
    }

    .glitch-menu-link:hover {
        color: var(--accent-color, #ff4d00);
        border-color: var(--accent-color, #ff4d00);
        background: rgba(255, 77, 0, 0.1);
    }

    .glitch-menu-link.inactive:hover {
        color: rgba(255,255,255,0.6);
        border-color: rgba(255,255,255,0.3);
        background: transparent;
    }

    .menu-separator {
        color: rgba(255,255,255,0.2);
        font-size: 14px;
    }

    /* グリッチアニメーション - 2秒に1回の周期 */
    .floor-3f-menu.visible .glitch-menu-link {
        animation: glitchText 2s ease-in-out infinite;
    }

    /* 2秒周期のアニメーション（最初の0.3秒でグリッチ、残りは待機） */
    @keyframes glitchText {
        0%, 100% {
            transform: translate(0);
            text-shadow: none;
        }
        3% {
            transform: translate(-3px, 2px);
            text-shadow: 3px 0 var(--accent-color, #ff4d00), -3px 0 cyan;
        }
        6% {
            transform: translate(3px, -2px);
            text-shadow: -3px 0 var(--accent-color, #ff4d00), 3px 0 cyan;
        }
        9% {
            transform: translate(-2px, -1px);
            text-shadow: 2px 0 cyan, -2px 0 var(--accent-color, #ff4d00);
        }
        12% {
            transform: translate(2px, 1px);
            text-shadow: -2px 0 cyan, 2px 0 var(--accent-color, #ff4d00);
        }
        15% {
            transform: translate(0);
            text-shadow: none;
        }
    }

    /* 初回登場時のグリッチ（強め） */
    .floor-3f-menu.glitch-active .glitch-menu-link {
        animation: glitchTextStrong 0.3s steps(2, end) 3 !important;
    }

    @keyframes glitchTextStrong {
        0% {
            transform: translate(0);
            text-shadow: none;
        }
        20% {
            transform: translate(-3px, 2px);
            text-shadow: 3px 0 var(--accent-color, #ff4d00), -3px 0 cyan;
        }
        40% {
            transform: translate(3px, -2px);
            text-shadow: -3px 0 var(--accent-color, #ff4d00), 3px 0 cyan;
        }
        60% {
            transform: translate(-2px, -1px);
            text-shadow: 2px 0 cyan, -2px 0 var(--accent-color, #ff4d00);
        }
        80% {
            transform: translate(2px, 1px);
            text-shadow: -2px 0 cyan, 2px 0 var(--accent-color, #ff4d00);
        }
        100% {
            transform: translate(0);
            text-shadow: none;
        }
    }

    /* グリッチバー（メニュー登場時の演出） */
    .floor-3f-menu.glitch-active::before,
    .floor-3f-menu.glitch-active::after {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--accent-color, #ff4d00);
        animation: glitchBar 0.3s steps(3, end) 3;
    }

    .floor-3f-menu.glitch-active::before {
        top: -5px;
    }

    .floor-3f-menu.glitch-active::after {
        bottom: -5px;
    }

    @keyframes glitchBar {
        0%, 100% {
            transform: translateX(0);
            opacity: 0;
        }
        25% {
            transform: translateX(-10px);
            opacity: 1;
        }
        50% {
            transform: translateX(10px);
            opacity: 0.5;
        }
        75% {
            transform: translateX(-5px);
            opacity: 1;
        }
    }
</style>

<script>
    if (typeof window !== 'undefined' && typeof Matter !== 'undefined' && typeof ScrollTrigger !== 'undefined') {
        /* ------------------------------------------------
           6. FOOTER PHYSICS
           ------------------------------------------------ */
        let footerEngine, footerRender, footerRunner;
    const footerCanvas = document.getElementById('footer-physics-canvas');
    const floor3Menu = document.getElementById('floor-guide-3f');

    // 3Fメニュー表示フラグ
    let floor3MenuShown = false;

    // 3Fメニューをグリッチエフェクトで表示
    const showFloor3Menu = () => {
        if (!floor3Menu || floor3MenuShown) return;
        floor3MenuShown = true;

        // グリッチエフェクトを開始
        floor3Menu.classList.add('glitch-active');
        floor3Menu.classList.add('visible');

        // グリッチエフェクトを0.9秒後に終了（0.3s × 3回）
        setTimeout(() => {
            floor3Menu.classList.remove('glitch-active');
        }, 900);

        console.log('3F Menu appeared with glitch effect');
    };

    // スクロール9010px到達後5秒でメニュー表示（よりゆっくり）
    const MENU_3F_SCROLL_TRIGGER = 9010;
    let scroll3FTriggered = false;

    const checkScroll3FMenu = () => {
        const scrollY = window.scrollY || window.pageYOffset || 0;
        if (scrollY >= MENU_3F_SCROLL_TRIGGER && !scroll3FTriggered) {
            scroll3FTriggered = true;
            console.log('Scroll reached 9010px, showing 3F menu in 5 seconds...');
            setTimeout(() => {
                showFloor3Menu();
            }, 5000);
        }
    };

    // スクロールイベントで監視
    window.addEventListener('scroll', checkScroll3FMenu, { passive: true });

    // 3Fメニューのクリックイベント
    const setup3FMenuLinks = () => {
        const menuLinks = document.querySelectorAll('#floor-guide-3f .glitch-menu-link[data-target]');
        menuLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('data-target');
                const target = document.querySelector(targetId);
                if (target && typeof Lenis !== 'undefined') {
                    // Lenisが初期化されている場合はLenisでスクロール
                    // Hero.astroでグローバルに公開されている場合
                    if (window.lenis) {
                        window.lenis.scrollTo(target, { duration: 1.5 });
                    } else {
                        // フォールバック: 通常のスクロール
                        target.scrollIntoView({ behavior: 'smooth' });
                    }
                } else if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });
    };

    // セットアップを実行
    setup3FMenuLinks();

    const cleanupFooterPhysics = () => {
        if (footerRender) {
            Matter.Render.stop(footerRender);
            Matter.Runner.stop(footerRunner);
            Matter.Engine.clear(footerEngine);
            if(footerRender.canvas) footerRender.canvas.remove();
            footerRender = null;
            footerEngine = null;
            footerRunner = null;
        }
    };

    const initFooterPhysics = () => {
        if (footerRender) return;

        const Engine = Matter.Engine,
              Render = Matter.Render,
              World = Matter.World,
              Bodies = Matter.Bodies,
              Mouse = Matter.Mouse,
              MouseConstraint = Matter.MouseConstraint,
              Runner = Matter.Runner,
              Events = Matter.Events;

        footerEngine = Engine.create();
        // 地球重力：普通の落下
        footerEngine.world.gravity.y = 1.0; // 地球重力
        footerEngine.world.gravity.scale = 0.001; // 標準スケール

        footerRender = Render.create({
            element: footerCanvas,
            engine: footerEngine,
            options: {
                width: window.innerWidth,
                height: window.innerHeight,
                background: 'transparent',
                wireframes: false
            }
        });

        const ground = Bodies.rectangle(window.innerWidth/2, window.innerHeight + 50, window.innerWidth, 100, { isStatic: true, render: { visible: false } });
        const leftWall = Bodies.rectangle(-50, window.innerHeight/2, 100, window.innerHeight, { isStatic: true, render: { visible: false } });
        const rightWall = Bodies.rectangle(window.innerWidth + 50, window.innerHeight/2, 100, window.innerHeight, { isStatic: true, render: { visible: false } });

        const labels = ['物語', '機材', '技術'];
        const colors = ['#ffffff', '#ff4d00', '#333333'];
        const links = ['#', '#', '#']; 

        const blocks = [];
        // ブロック数: 48個
        for (let i = 0; i < 48; i++) {
            const x = Math.random() * (window.innerWidth - 150) + 75;
            const y = -Math.random() * 1500 - 100; // 順番にジャラジャラ落ちてくる
            const typeIdx = Math.floor(Math.random() * 3);

            const block = Bodies.rectangle(x, y, 140, 70, {
                chamfer: { radius: 10 },
                restitution: 0.3, // 軽いバウンド
                density: 0.001, // 密度1.0相当
                friction: 0.5, // 標準摩擦
                frictionAir: 0, // 空気抵抗なし
                label: labels[typeIdx],
                render: {
                    fillStyle: colors[typeIdx],
                    strokeStyle: '#ffffff',
                    lineWidth: 2
                }
            });
            block.urlLink = links[typeIdx];
            blocks.push(block);
        }

        World.add(footerEngine.world, [ground, leftWall, rightWall, ...blocks]);

        const mouse = Mouse.create(footerRender.canvas);
        const mouseConstraint = MouseConstraint.create(footerEngine, {
            mouse: mouse,
            constraint: { stiffness: 0.2, render: { visible: false } }
        });
        World.add(footerEngine.world, mouseConstraint);
        footerRender.mouse = mouse;

        Events.on(mouseConstraint, 'mousedown', function(event) {
            const body = event.source.body;
            if (body && body.label) {
                console.log("Navigating to: " + body.label);
            }
        });

        Events.on(footerRender, 'afterRender', function() {
            const ctx = footerRender.context;
            ctx.font = "bold 16px 'Noto Sans JP'"; 
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            blocks.forEach(block => {
                const { x, y } = block.position;
                const angle = block.angle;
                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle);
                ctx.fillStyle = block.render.fillStyle === '#ffffff' ? '#000' : '#fff';
                ctx.fillText(block.label, 0, 0);
                ctx.restore();
            });
        });

        footerRunner = Runner.create();
        Runner.run(footerRunner, footerEngine);
        Render.run(footerRender);

        // ブロックが安定したら物理演算を停止（ずっと動き続けるのを防ぐ）
        let stableFrames = 0;
        const checkStability = () => {
            if (!footerEngine || !footerRunner) return;

            // 全ブロックの速度をチェック
            let allSleeping = true;
            blocks.forEach(block => {
                const speed = Math.sqrt(block.velocity.x ** 2 + block.velocity.y ** 2);
                if (speed > 0.1) { // 速度が0.1以上なら動いている
                    allSleeping = false;
                }
            });

            if (allSleeping) {
                stableFrames++;
                if (stableFrames > 120) { // 2秒安定したら停止（60fps × 2秒）
                    Matter.Runner.stop(footerRunner);
                    console.log('Footer physics stopped - blocks stable');
                    // メニューはスクロールベースのトリガーで表示（9010px到達後3秒）
                    return; // 監視終了
                }
            } else {
                stableFrames = 0;
            }

            requestAnimationFrame(checkStability);
        };

        // 3秒後から安定性チェック開始（落下完了を待つ）
        setTimeout(() => {
            requestAnimationFrame(checkStability);
        }, 3000);

        window.addEventListener('resize', () => {
            if(footerRender) {
                footerRender.canvas.width = window.innerWidth;
                footerRender.canvas.height = window.innerHeight;
            }
        });
    };

    ScrollTrigger.create({
        trigger: "#footer-physics-wrapper",
        start: "top 60%", 
        onEnter: initFooterPhysics,
        onLeaveBack: cleanupFooterPhysics 
    });
    }
</script>
